@{
    ViewBag.Title = "Авансовый отчет";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/Content/DataTables/css/dataTables.bootstrap.min.css" rel="stylesheet" />
<link href="~/Content/DataTables/css/responsive.bootstrap.min.css" rel="stylesheet" />
<link href="~/Content/DataTables/css/fixedHeader.dataTables.min.css" rel="stylesheet" />
<link href="~/Content/DataTables/css/fixedHeader.bootstrap.min.css" rel="stylesheet" />
<link href="~/Scripts/DateRangePicker/daterangepicker.min.css" rel="stylesheet" />
<link href="~/Content/jquery.contextMenu.min.css" rel="stylesheet" />

<div id="loadingImg">
    <div id="preloadImg">
        <img src="~/Content/Images/loader.gif" />
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <h1 class="page-header">
                ОТЧЕТЫ
                <small>Альтернативный авансовый отчет</small>
            </h1>
            <ol class="breadcrumb">
                <li>@Html.ActionLink("Главная", "Index", "Home", new { Area = "" }, null)</li>
                <li>Персональный раздел</li>
                <li class="active">Альтернативный авансовый отчет</li>
            </ol>
        </div>
    </div>

    <div class="row">
        <table class="table table table-bordered table-striped table-responsive table-hover gridtable" id="gridtable" style="width:100%">
            <thead>
                <tr role="row" id="search-row" style="background-color:#ddddff">
                    <th><input type="text" class="form-control input-sm dff dateFlt" readonly style="width: 100%" placeholder="Дата" value="@ViewData["Period"]" id="dateFlt" /></th>
                    <th><input type="text" class="form-control input-sm sb chFlt" style="width: 100%" placeholder="Документ" /></th>
                    <th><input type="text" class="form-control input-sm sb chFlt" style="width: 100%" placeholder="Операция" /></th>
                    <th><input type="text" class="form-control input-sm sb orgFlt" style="width: 100%" placeholder="Контрагент" /></th>
                    <th><input type="text" class="form-control input-sm sb" style="width: 100%" placeholder="Передано" /></th>
                    <th><input type="text" class="form-control input-sm sb" style="width: 100%" placeholder="Получено" /></th>
                    <th><input type="text" class="form-control input-sm sb currFlt" style="width: 100%" placeholder="&#8372" /></th>
                </tr>
                <tr role="row">
                    <th>Дата</th>
                    <th>Документ</th>
                    <th>Операция</th>
                    <th>Контрагент</th>
                    <th>Передано</th>
                    <th>Получено</th>
                    <th>&#8372</th>
                </tr>
            </thead>
            <tfoot>
                <tr>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
            </tfoot>
            <tbody></tbody>
        </table>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script src="~/Scripts/DataTables/jquery.dataTables.min.js"></script>
    <script src="~/Scripts/DataTables/dataTables.bootstrap.min.js"></script>
    <script src="~/Scripts/DataTables/dataTables.responsive.min.js"></script>
    <script src="~/Scripts/DataTables/responsive.bootstrap.min.js"></script>
    <script src="~/Scripts/DataTables/dataTables.fixedHeader.min.js"></script>
    <script src="~/Scripts/jquery.contextMenu.min.js"></script>
    <script src="~/Scripts/FRScripts/toparrow.js"></script>

    @*Блок скриптов для работы с DateRangePicker*@
    <script src="~/Scripts/moment.min.js"></script>
    <script src="~/Scripts/DateRangePicker/jquery.daterangepicker.min.js"></script>
    <script>
        $(function () {
            $('.dff').each(function () {
                $(this).dateRangePicker(
                     {
                         language: 'ru',
                         startOfWeek: 'monday',
                         separator: ' - ',
                         format: 'DD/MM/YYYY',
                         autoClose: false,
                         monthSelect: true,
                         yearSelect: true,
                         setValue: function (s) {
                             $(this).val(s);
                         },
                         customOpenAnimation: function (cb) {
                             $(this).fadeIn(300, cb);
                         },
                         customCloseAnimation: function (cb) {
                             $(this).fadeOut(300, cb);
                         },
                         showShortcuts: false,
                         time: {
                             enabled: false
                         },
                         extraClass: 'date-range-pickerM'
                     })
                .bind('datepicker-closed', function (event, obj) {
                    $(this).attr('title', $(this).val()).trigger('change');
                })
                .bind('datepicker-open', function () {
                    $(this).data('dateRangePicker').clear();
                });

            });
        });
    </script>



    <script>
        //-----------Функция создания таблицы отчета------------
        $(function () {
            $('#loadingImg').hide();
            var table = $('#gridtable')
                .DataTable({
                    "fixedHeader": {
                        "header": true,
                        "footer": true,
                        "headerOffset": $('#mainNavbar').height()
                    },
                    autoWidth: true,
                    paging: true,
                    processing: true,
                    serverSide: true,
                    filter: false,
                    orderMulti: false,
                    responsive: false,
                    lengthMenu: [
                                    [10, 25, 50, 100],
                                    ['10', '25', '50', '100']
                    ],
                    pageLength: 25, // Количество записей в таблице по умолчанию
                    pagingType: "simple_numbers",
                    dom: "<'row'<'col-sm-3'l><'#alrt.col-sm-6 text-center'><'#repDT.col-sm-3 text-right'B>>" +
                        "<'row'<'col-sm-12'tr>>" +
                        "<'row'<'col-sm-5'i><'col-sm-7'p>>",
                    language: {
                        lengthMenu: "Записей: _MENU_",
                        zeroRecords: "Записи отсутствуют",
                        info: "Страница _PAGE_ из _PAGES_. Записи _START_ - _END_ из _TOTAL_",
                        infoEmpty: "Записи отсутствуют",
                        infoFiltered: "(Отфильтровано из _MAX_ записей)",
                        search: "",
                        searchPlaceholder: "Проект...",
                        processing: "<div id='loadingImg'><div id='preloadImg'><img src='../Content/Images/loader.gif' /></div></div>",
                        sInfoThousands: " ",
                        oPaginate: {
                            sNext: ">",
                            sPrevious: "<"
                        }
                    },
                    ajax: {
                        type: 'POST',
                        url: '/Reports/GetAAR/',
                        datatype: "json",
                        data: function (d) {
                        },
                        dataSrc: function (d) {
                            $('#loadingImg').hide();
                            if (!d.result) {
                                alert(d.message);
                                return false;
                            }
                            else {
                                return d.data;
                            }
                        },
                    },
                    order: [0, "desc"],
                    columns: [
                                {
                                    "data": "Date", "name": "Date", "autoWidth": true, "type": "date ",
                                    "render": function (value) {
                                        return formatDate(value);
                                    },
                                    "class": "dateCellf context-menu-one"
                                },
                                { data: "DocNumber", "autoWidth": true, bSortable: true, name: "DocNumber", "class": "context-menu-one" },
                                { data: "Operation", "autoWidth": true, bSortable: true, name: "Operation", "class": "context-menu-one" },
                                { data: "Counteragent", "autoWidth": true, bSortable: true, name: "Counteragent", "class": "context-menu-one" },
                                { data: "Payed", name: "Payed", "autoWidth": true, render: $.fn.dataTable.render.number('&nbsp;', ',', 2), bSortable: true, "class": "text-right context-menu-one" },
                                { data: "Received", name: "Received", "autoWidth": true, render: $.fn.dataTable.render.number('&nbsp;', ',', 2), bSortable: true, "class": "text-right context-menu-one" },
                                { "data": "Currency", "name": "Currency", "autoWidth": true, "class": "currCellf context-menu-one" }
                    ],

                    fnCreatedRow: function (row, data, rowIndex) {

                        ////Выводим всплывающую подсказку с подробной информацией о проекте
                        //var _datePlan = formatDate(data.StartDatePlan);
                        //var _dateFact = formatDate(data.StartDateFact);
                        //var _planBenefit = data.planBenefit.toFixed(2).replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1 ");
                        //var _planExpand = data.planExpand.toFixed(2).replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1 ");
                        //var _IPA = 'Платежи отсутствуют';
                        //if (data.IPA !== null) {
                        //    _IPA = moment(eval(data.IPA.replace(/\/Date\((\d+)\)\//gi, "new Date($1)"))).format('DD/MM/YYYY');
                        //}
                        //var prgTitleStr = 'Индекс активности: ' + _IPA;
                        //prgTitleStr += '\r\nТип проекта: ' + data.ProjectType + '\r\nРуководитель: ' + data.ChiefName + '\r\nМенеджер: ' + data.ProjectManagerName;
                        //prgTitleStr += '\r\nДата начала (план): ' + _datePlan + '\r\nДата начала (факт): ' + _dateFact;
                        //prgTitleStr += '\r\nПлан доходов: ' + _planBenefit + '\r\nПлан расходов: ' + _planExpand;
                        //$('.prgCellf', $(row)).attr('title', prgTitleStr);

                        //// Выделение цветом дельта-ячеек
                        //if (data.IncomeTotal > 0) {
                        //    $('td:eq(9)', row).css('color', '#006400');
                        //}
                        //else if (data.IncomeTotal < 0) {
                        //    $('td:eq(9)', row).css('color', '#b22222');
                        //}
                    },

                    fnDrawCallback: function (settings) {
                        //var api = this.api();
                        //var json = api.ajax.json();

                        ////Заполнение футера
                        //var numFormat = $.fn.dataTable.render.number('&nbsp;', ',', 2).display;
                        //$(api.column(1).footer()).html(numFormat(json.total.FactCreditF1Total));
                        //$(api.column(2).footer()).html(numFormat(json.total.FactCreditF2Total));
                        //$(api.column(3).footer()).html(numFormat(json.total.FCF1F2Total));
                        //$(api.column(4).footer()).html(numFormat(json.total.FactDebitF1Total));
                        //$(api.column(5).footer()).html(numFormat(json.total.FactDebitF2Total));
                        //$(api.column(6).footer()).html(numFormat(json.total.FDF1F2Total));
                        //$(api.column(7).footer()).html(numFormat(json.total.IncomeF1Total));
                        //$(api.column(8).footer()).html(numFormat(json.total.IncomeF2Total));
                        //$(api.column(9).footer()).html(numFormat(json.total.IncomeTotal));

                        //if (json.total.IncomeTotal * 1 > 0) { $('tr:eq(0) th:eq(9)', api.table().footer()).css('color', '#006400'); }
                        //else if (json.total.IncomeTotal * 1 < 0) { $('tr:eq(0) th:eq(9)', api.table().footer()).css('color', '#b22222'); }

                        ////Инициализация таблицы проектов в плавающей панели
                        //if (window._flag) {
                        //    //Заполнение массива проектов для таблицы в плавающей панели
                        //    _prjIDs = JSON.parse(json.prjlist)
                        //    var pTable = $('#prgtable').DataTable();
                        //    pTable.destroy();
                        //    prgTableCrate();
                        //    $('#flowPanel').height($('#prgtable_wrapper').height() + 80);
                        //    window._flag = false;
                        //};
                    }

                });

            table.columns().eq(0).each(function (colIdx) {
                $('.sb', $('th')[colIdx]).on('keyup change', function () {
                    table.column(colIdx).search(this.value).draw();
                });

                $('.dff', $('th')[colIdx]).on('change', function () {
                    table.column(colIdx).search(this.value).draw();
                });
            });
        });

        function formatDate(value) {
            if (value === null) return "";
            var pattern = /Date\(([^)]+)\)/;
            var results = pattern.exec(value);
            var dt = new Date(parseFloat(results[1]));
            var _d = dt.getDate() < 10 ? "0" + dt.getDate() : dt.getDate();
            var _m = (dt.getMonth() + 1) < 10 ? "0" + (dt.getMonth() + 1) : (dt.getMonth() + 1);
            return _d + "/" + _m + "/" + dt.getFullYear();
        };

    </script>
}